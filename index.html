<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description" content="Ringoptima Enterprise - Intelligent kontakthantering och samtalsloggning">
    <meta name="theme-color" content="#2596be">
    <title>Ringoptima Enterprise</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --color-primary: #2596be;
            --color-secondary: #765db6;
            --color-success: #10b981;
            --color-warning: #f59e0b;
            --color-danger: #ef4444;
            --color-info: #3b82f6;
            --glass-bg: rgba(255, 255, 255, 0.12);
            --glass-border: rgba(255, 255, 255, 0.25);
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.1);
            --shadow-md: 0 8px 32px rgba(0,0,0,0.15);
            --shadow-lg: 0 16px 48px rgba(0,0,0,0.2);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 20px;
            --radius-xl: 28px;
            --transition-fast: 0.15s ease;
            --transition-normal: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        html { scroll-behavior: smooth; }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%);
            min-height: 100vh;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        :focus-visible { outline: 3px solid rgba(255,255,255,0.8); outline-offset: 2px; }

        .skip-link {
            position: absolute; top: -100px; left: 50%; transform: translateX(-50%);
            background: white; color: var(--color-primary); padding: 12px 24px;
            border-radius: var(--radius-md); font-weight: 600; z-index: 10000;
        }
        .skip-link:focus { top: 16px; }

        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; }
        .orb { position: absolute; border-radius: 50%; background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.3), transparent 70%); filter: blur(60px); }
        .orb-1 { width: 500px; height: 500px; top: -150px; left: -150px; animation: float1 25s ease-in-out infinite; }
        .orb-2 { width: 400px; height: 400px; bottom: -100px; right: -100px; animation: float2 30s ease-in-out infinite; }
        .orb-3 { width: 350px; height: 350px; top: 40%; right: -100px; animation: float3 28s ease-in-out infinite; }

        @keyframes float1 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(80px, 120px); } }
        @keyframes float2 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-100px, -80px); } }
        @keyframes float3 { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(-120px, 80px); } }

        .app-container { display: flex; min-height: 100vh; position: relative; z-index: 1; }

        /* Sidebar */
        .sidebar {
            width: 280px; background: var(--glass-bg); backdrop-filter: blur(40px);
            border-right: 1px solid var(--glass-border); padding: 24px 16px;
            display: flex; flex-direction: column; position: fixed; top: 0; left: 0;
            height: 100vh; z-index: 100; transition: transform var(--transition-normal);
        }
        .sidebar.hidden { transform: translateX(-100%); }
        .main-content { transition: margin-left var(--transition-normal); }
        body.sidebar-hidden .main-content { margin-left: 0; }

        /* Sidebar Toggle Button */
        .sidebar-toggle {
            position: fixed; top: 20px; left: 290px; width: 36px; height: 36px;
            border-radius: var(--radius-sm); border: none;
            background: var(--glass-bg); backdrop-filter: blur(20px);
            color: white; cursor: pointer; z-index: 101;
            display: flex; align-items: center; justify-content: center;
            transition: left var(--transition-normal), background var(--transition-fast);
            border: 1px solid var(--glass-border);
        }
        .sidebar-toggle:hover { background: rgba(255,255,255,0.2); }
        .sidebar-toggle svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; transition: transform var(--transition-fast); }
        body.sidebar-hidden .sidebar-toggle { left: 16px; }
        body.sidebar-hidden .sidebar-toggle svg { transform: rotate(180deg); }

        .sidebar-header { display: flex; align-items: center; gap: 12px; padding: 0 8px 24px; border-bottom: 1px solid var(--glass-border); margin-bottom: 24px; }
        .logo { width: 48px; height: 48px; background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0.1)); border-radius: var(--radius-md); display: flex; align-items: center; justify-content: center; }
        .logo svg { width: 28px; height: 28px; stroke: white; }
        .brand { color: white; }
        .brand h1 { font-size: 1.4rem; font-weight: 800; }
        .brand span { font-size: 0.7rem; opacity: 0.8; text-transform: uppercase; letter-spacing: 1px; }

        .nav-section { margin-bottom: 24px; }
        .nav-label { color: rgba(255,255,255,0.6); font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1.5px; padding: 0 12px; margin-bottom: 8px; }
        .nav-item { display: flex; align-items: center; gap: 12px; padding: 12px 16px; border-radius: var(--radius-md); color: rgba(255,255,255,0.85); font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: all var(--transition-fast); border: none; background: transparent; width: 100%; text-align: left; }
        .nav-item:hover { background: rgba(255,255,255,0.1); color: white; }
        .nav-item.active { background: rgba(255,255,255,0.2); color: white; }
        .nav-item svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }
        .nav-badge { margin-left: auto; background: var(--color-success); color: white; font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 10px; }

        .sidebar-stats { margin-top: auto; padding: 16px; background: rgba(255,255,255,0.08); border-radius: var(--radius-md); }
        .stat-row { display: flex; justify-content: space-between; align-items: center; padding: 8px 0; color: white; font-size: 0.85rem; }
        .stat-row:not(:last-child) { border-bottom: 1px solid rgba(255,255,255,0.1); }
        .stat-value { font-weight: 700; }

        /* Main Content */
        .main-content { flex: 1; margin-left: 280px; padding: 24px; min-height: 100vh; }

        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; flex-wrap: wrap; gap: 16px; }
        .header-left h2 { color: white; font-size: 1.8rem; font-weight: 700; }
        .header-left p { color: rgba(255,255,255,0.8); font-size: 0.9rem; margin-top: 4px; }
        .header-actions { display: flex; gap: 12px; flex-wrap: wrap; }

        /* Buttons */
        .btn { display: inline-flex; align-items: center; gap: 8px; padding: 12px 20px; border-radius: var(--radius-md); font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all var(--transition-fast); border: none; font-family: inherit; }
        .btn svg { width: 18px; height: 18px; stroke: currentColor; stroke-width: 2; fill: none; }
        .btn-primary { background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: var(--shadow-md); }
        .btn-glass { background: var(--glass-bg); backdrop-filter: blur(20px); color: white; border: 1px solid var(--glass-border); }
        .btn-glass:hover { background: rgba(255,255,255,0.2); }
        .btn-success { background: var(--color-success); color: white; }
        .btn-danger { background: var(--color-danger); color: white; }
        .btn-sm { padding: 8px 14px; font-size: 0.8rem; }

        /* Search */
        .search-filter-bar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; }
        .search-box { flex: 1; min-width: 250px; position: relative; }
        .search-box svg { position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; stroke: rgba(255,255,255,0.6); }
        .search-input { width: 100%; padding: 12px 16px 12px 44px; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: white; font-size: 0.9rem; }
        .search-input::placeholder { color: rgba(255,255,255,0.5); }
        .search-input:focus { border-color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.15); outline: none; }

        .filter-select { padding: 12px 40px 12px 16px; background: var(--glass-bg); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: var(--radius-md); color: white; font-size: 0.9rem; cursor: pointer; appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='white' d='M6 9L1 4h10z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 14px center; }
        .filter-select option { background: #2596be; color: white; }

        /* Stats Grid */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
        .stat-card { background: var(--glass-bg); backdrop-filter: blur(30px); border-radius: var(--radius-lg); padding: 20px; border: 1px solid var(--glass-border); transition: all var(--transition-normal); position: relative; overflow: hidden; cursor: pointer; }
        .stat-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
        .stat-card.telenor::before { background: #00bcd4; }
        .stat-card.tele2::before { background: #4caf50; }
        .stat-card.tre::before { background: #9c27b0; }
        .stat-card.telia::before { background: #ff9800; }
        .stat-card.total::before { background: linear-gradient(90deg, var(--color-primary), var(--color-secondary)); }
        .stat-card:hover { transform: translateY(-4px); box-shadow: var(--shadow-md); background: rgba(255,255,255,0.18); }
        .stat-card.active { box-shadow: 0 0 0 2px white, var(--shadow-md); }

        .stat-card-icon { width: 40px; height: 40px; border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center; margin-bottom: 12px; }
        .stat-card.telenor .stat-card-icon { background: rgba(0,188,212,0.2); }
        .stat-card.tele2 .stat-card-icon { background: rgba(76,175,80,0.2); }
        .stat-card.tre .stat-card-icon { background: rgba(156,39,176,0.2); }
        .stat-card.telia .stat-card-icon { background: rgba(255,152,0,0.2); }
        .stat-card.total .stat-card-icon { background: rgba(255,255,255,0.15); }
        .stat-card-icon svg { width: 22px; height: 22px; stroke-width: 2; fill: none; }
        .stat-card.telenor .stat-card-icon svg { stroke: #00bcd4; }
        .stat-card.tele2 .stat-card-icon svg { stroke: #4caf50; }
        .stat-card.tre .stat-card-icon svg { stroke: #9c27b0; }
        .stat-card.telia .stat-card-icon svg { stroke: #ff9800; }
        .stat-card.total .stat-card-icon svg { stroke: white; }

        .stat-card-value { color: white; font-size: 2rem; font-weight: 800; line-height: 1; }
        .stat-card-label { color: rgba(255,255,255,0.7); font-size: 0.8rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; margin-top: 4px; }

        /* Glass Panel */
        .glass-panel { background: var(--glass-bg); backdrop-filter: blur(40px); border-radius: var(--radius-xl); border: 1px solid var(--glass-border); box-shadow: var(--shadow-lg); overflow: hidden; }
        .panel-header { padding: 20px 24px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px; }
        .panel-title { color: white; font-size: 1.1rem; font-weight: 700; display: flex; align-items: center; gap: 10px; }
        .panel-title svg { width: 22px; height: 22px; stroke: currentColor; stroke-width: 2; fill: none; }

        /* Table */
        .table-container { overflow-x: auto; max-height: 600px; overflow-y: auto; }
        .table-container::-webkit-scrollbar { width: 8px; height: 8px; }
        .table-container::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        .table-container::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        .data-table { width: 100%; border-collapse: collapse; min-width: 1400px; }
        .data-table th { position: sticky; top: 0; background: rgba(37,150,190,0.95); backdrop-filter: blur(10px); color: white; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; padding: 14px 12px; text-align: left; white-space: nowrap; z-index: 10; }
        .data-table td { padding: 12px; color: rgba(255,255,255,0.95); font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.08); vertical-align: top; }
        .data-table tbody tr { transition: background var(--transition-fast); }
        .data-table tbody tr:hover { background: rgba(255,255,255,0.08); }

        .cell-company { font-weight: 600; max-width: 180px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .cell-multiline { white-space: pre-line; line-height: 1.5; max-width: 150px; font-size: 0.75rem; }

        /* Inline Note Box */
        .inline-note { width: 100%; min-width: 120px; }
        .inline-note textarea { width: 100%; padding: 8px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: var(--radius-sm); color: white; font-size: 0.75rem; font-family: inherit; resize: vertical; min-height: 50px; transition: all var(--transition-fast); }
        .inline-note textarea::placeholder { color: rgba(255,255,255,0.4); }
        .inline-note textarea:focus { outline: none; border-color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.15); }

        /* Row Actions */
        .row-actions { display: flex; gap: 4px; flex-wrap: wrap; }
        .action-btn { width: 28px; height: 28px; border-radius: var(--radius-sm); border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all var(--transition-fast); }
        .action-btn:hover { background: rgba(255,255,255,0.2); }
        .action-btn.call { color: var(--color-success); }
        .action-btn.call:hover { background: rgba(16,185,129,0.3); }
        .action-btn.delete { color: var(--color-danger); }
        .action-btn.delete:hover { background: rgba(239,68,68,0.3); }
        .action-btn svg { width: 14px; height: 14px; stroke: currentColor; stroke-width: 2; fill: none; }

        /* Batch Management */
        .batch-list { padding: 16px; }
        .batch-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; background: rgba(255,255,255,0.08); border-radius: var(--radius-md); margin-bottom: 8px; }
        .batch-info { color: white; }
        .batch-name { font-weight: 600; font-size: 0.9rem; }
        .batch-meta { font-size: 0.75rem; color: rgba(255,255,255,0.7); margin-top: 4px; }
        .batch-actions { display: flex; gap: 8px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(8px); display: flex; align-items: center; justify-content: center; z-index: 1000; opacity: 0; visibility: hidden; transition: all var(--transition-normal); padding: 20px; }
        .modal-overlay.active { opacity: 1; visibility: visible; }
        .modal { background: linear-gradient(135deg, rgba(37,150,190,0.95), rgba(118,93,182,0.95)); backdrop-filter: blur(40px); border-radius: var(--radius-xl); border: 1px solid var(--glass-border); width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto; transform: scale(0.9); transition: transform var(--transition-normal); }
        .modal-overlay.active .modal { transform: scale(1); }
        .modal-header { padding: 24px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .modal-title { color: white; font-size: 1.3rem; font-weight: 700; }
        .modal-close { width: 36px; height: 36px; border-radius: 50%; border: none; background: rgba(255,255,255,0.1); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .modal-close:hover { background: rgba(255,255,255,0.2); }
        .modal-close svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; }
        .modal-body { padding: 24px; }
        .modal-footer { padding: 16px 24px; border-top: 1px solid var(--glass-border); display: flex; justify-content: flex-end; gap: 12px; }

        /* Form */
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; color: white; font-size: 0.85rem; font-weight: 600; margin-bottom: 8px; }
        .form-input, .form-textarea, .form-select { width: 100%; padding: 12px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: var(--radius-md); color: white; font-size: 0.9rem; font-family: inherit; }
        .form-input::placeholder, .form-textarea::placeholder { color: rgba(255,255,255,0.5); }
        .form-input:focus, .form-textarea:focus, .form-select:focus { border-color: rgba(255,255,255,0.5); background: rgba(255,255,255,0.15); outline: none; }
        .form-textarea { min-height: 100px; resize: vertical; }
        .form-select option { background: var(--color-primary); }

        /* Upload */
        .upload-area { border: 2px dashed rgba(255,255,255,0.3); border-radius: var(--radius-lg); padding: 48px 24px; text-align: center; cursor: pointer; transition: all var(--transition-normal); background: rgba(255,255,255,0.05); }
        .upload-area:hover, .upload-area.dragover { border-color: rgba(255,255,255,0.6); background: rgba(255,255,255,0.1); }
        .upload-icon { width: 64px; height: 64px; margin: 0 auto 16px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .upload-icon svg { width: 32px; height: 32px; stroke: white; stroke-width: 2; fill: none; }
        .upload-text { color: white; font-size: 1.1rem; font-weight: 600; margin-bottom: 8px; }
        .upload-hint { color: rgba(255,255,255,0.7); font-size: 0.9rem; }

        /* Chat Panel */
        .chat-panel { position: fixed; right: -420px; top: 0; width: 400px; height: 100vh; background: linear-gradient(180deg, rgba(37,150,190,0.98), rgba(118,93,182,0.98)); backdrop-filter: blur(40px); border-left: 1px solid var(--glass-border); z-index: 200; display: flex; flex-direction: column; transition: right var(--transition-normal); }
        .chat-panel.open { right: 0; }
        .chat-header { padding: 20px; border-bottom: 1px solid var(--glass-border); display: flex; justify-content: space-between; align-items: center; }
        .chat-header-left { display: flex; align-items: center; gap: 12px; }
        .chat-avatar { width: 40px; height: 40px; background: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .chat-avatar svg { width: 24px; height: 24px; stroke: var(--color-primary); stroke-width: 2; fill: none; }
        .chat-title { color: white; font-weight: 700; }
        .chat-subtitle { color: rgba(255,255,255,0.7); font-size: 0.75rem; }
        .chat-messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 16px; }
        .chat-message { max-width: 85%; padding: 12px 16px; border-radius: var(--radius-md); font-size: 0.9rem; line-height: 1.5; }
        .chat-message.user { background: rgba(255,255,255,0.2); color: white; align-self: flex-end; }
        .chat-message.assistant { background: rgba(255,255,255,0.95); color: #1a1a1a; align-self: flex-start; }
        .chat-input-area { padding: 16px; border-top: 1px solid var(--glass-border); }
        .chat-input-wrapper { display: flex; gap: 10px; }
        .chat-input { flex: 1; padding: 12px 16px; background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: var(--radius-md); color: white; font-size: 0.9rem; }
        .chat-input::placeholder { color: rgba(255,255,255,0.5); }
        .chat-send { width: 44px; height: 44px; border-radius: var(--radius-md); border: none; background: white; color: var(--color-primary); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .chat-send svg { width: 20px; height: 20px; stroke: currentColor; stroke-width: 2; fill: none; }

        .chat-toggle { position: fixed; bottom: 24px; right: 24px; width: 60px; height: 60px; border-radius: 50%; border: none; background: linear-gradient(135deg, var(--color-primary), var(--color-secondary)); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; box-shadow: var(--shadow-lg); z-index: 150; transition: transform var(--transition-normal); }
        .chat-toggle:hover { transform: scale(1.1); }
        .chat-toggle svg { width: 28px; height: 28px; stroke: currentColor; stroke-width: 2; fill: none; }

        /* Toast */
        .toast-container { position: fixed; top: 24px; right: 24px; z-index: 2000; display: flex; flex-direction: column; gap: 12px; }
        .toast { background: white; border-radius: var(--radius-md); padding: 16px 20px; box-shadow: var(--shadow-lg); display: flex; align-items: center; gap: 12px; min-width: 300px; transform: translateX(120%); transition: transform var(--transition-normal); }
        .toast.show { transform: translateX(0); }
        .toast-icon { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .toast-icon svg { width: 14px; height: 14px; stroke: white; stroke-width: 3; fill: none; }
        .toast.success .toast-icon { background: var(--color-success); }
        .toast.error .toast-icon { background: var(--color-danger); }
        .toast.info .toast-icon { background: var(--color-info); }
        .toast-message { color: #1a1a1a; font-size: 0.9rem; font-weight: 500; }

        /* Empty State */
        .empty-state { text-align: center; padding: 60px 20px; color: white; }
        .empty-state svg { width: 80px; height: 80px; stroke: rgba(255,255,255,0.4); stroke-width: 1.5; fill: none; margin-bottom: 20px; }
        .empty-state h3 { font-size: 1.3rem; margin-bottom: 8px; }
        .empty-state p { color: rgba(255,255,255,0.7); max-width: 400px; margin: 0 auto; }

        /* Mobile */
        .mobile-menu-btn { display: none; position: fixed; top: 16px; left: 16px; width: 44px; height: 44px; border-radius: var(--radius-md); border: none; background: var(--glass-bg); backdrop-filter: blur(20px); color: white; cursor: pointer; z-index: 150; align-items: center; justify-content: center; }
        .mobile-menu-btn svg { width: 24px; height: 24px; stroke: currentColor; stroke-width: 2; fill: none; }

        @media (max-width: 1024px) {
            .sidebar { transform: translateX(-100%); }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-left: 0; }
            .mobile-menu-btn { display: flex; }
            .sidebar-toggle { display: none; }
            .header { padding-top: 60px; }
            .chat-panel { width: 100%; right: -100%; }
        }

        @media (max-width: 768px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .search-filter-bar { flex-direction: column; }
            .search-box { min-width: 100%; }
        }
    </style>
</head>
<body>
    <a href="#main" class="skip-link">Hoppa till huvudinnehåll</a>
    <div class="bg-animation"><div class="orb orb-1"></div><div class="orb orb-2"></div><div class="orb orb-3"></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <button class="mobile-menu-btn" id="mobileMenuBtn"><svg viewBox="0 0 24 24"><path d="M3 12h18M3 6h18M3 18h18"/></svg></button>
    <button class="sidebar-toggle" id="sidebarToggle"><svg viewBox="0 0 24 24"><polyline points="15 18 9 12 15 6"/></svg></button>

    <div class="app-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="logo"><svg viewBox="0 0 24 24" stroke="currentColor" fill="none" stroke-width="2"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72"/></svg></div>
                <div class="brand"><h1>Ringoptima</h1><span>Enterprise</span></div>
            </div>

            <nav class="nav-section">
                <div class="nav-label">Huvudmeny</div>
                <button class="nav-item active" data-view="dashboard"><svg viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="9"/><rect x="14" y="3" width="7" height="5"/><rect x="14" y="12" width="7" height="9"/><rect x="3" y="16" width="7" height="5"/></svg>Dashboard</button>
                <button class="nav-item" data-view="contacts"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>Kontakter<span class="nav-badge" id="contactCount">0</span></button>
                <button class="nav-item" data-view="batches"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Importerade Listor</button>
            </nav>

            <nav class="nav-section">
                <div class="nav-label">Verktyg</div>
                <button class="nav-item" data-action="import"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Importera Data</button>
                <button class="nav-item" data-action="export"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Exportera CSV</button>
            </nav>

            <div class="sidebar-stats">
                <div class="stat-row"><span>Totalt kontakter</span><span class="stat-value" id="sidebarTotal">0</span></div>
                <div class="stat-row"><span>Importerade listor</span><span class="stat-value" id="sidebarBatches">0</span></div>
            </div>
        </aside>

        <main class="main-content" id="main">
            <!-- Dashboard -->
            <section id="dashboardView" class="view active">
                <div class="header">
                    <div class="header-left"><h2>Dashboard</h2><p>Klicka på en operatör för att filtrera kontakter</p></div>
                    <div class="header-actions">
                        <button class="btn btn-glass" data-action="import"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>Importera</button>
                        <button class="btn btn-primary" id="openChatBtn"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>AI Assistent</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card total" data-filter="all">
                        <div class="stat-card-icon"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg></div>
                        <div class="stat-card-value" id="statTotal">0</div>
                        <div class="stat-card-label">Totalt</div>
                    </div>
                    <div class="stat-card telenor" data-filter="telenor">
                        <div class="stat-card-icon"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg></div>
                        <div class="stat-card-value" id="statTelenor">0</div>
                        <div class="stat-card-label">Telenor</div>
                    </div>
                    <div class="stat-card tele2" data-filter="tele2">
                        <div class="stat-card-icon"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg></div>
                        <div class="stat-card-value" id="statTele2">0</div>
                        <div class="stat-card-label">Tele2</div>
                    </div>
                    <div class="stat-card tre" data-filter="tre">
                        <div class="stat-card-icon"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg></div>
                        <div class="stat-card-value" id="statTre">0</div>
                        <div class="stat-card-label">Tre</div>
                    </div>
                    <div class="stat-card telia" data-filter="telia">
                        <div class="stat-card-icon"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg></div>
                        <div class="stat-card-value" id="statTelia">0</div>
                        <div class="stat-card-label">Telia</div>
                    </div>
                </div>

                <div class="glass-panel">
                    <div class="panel-header">
                        <h3 class="panel-title"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>Snabbvy - Senaste kontakter</h3>
                    </div>
                    <div id="recentContacts" style="padding: 20px;">
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                            <h3>Inga kontakter</h3>
                            <p>Importera en CSV-fil för att komma igång.</p>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Contacts -->
            <section id="contactsView" class="view" style="display:none;">
                <div class="header">
                    <div class="header-left"><h2>Kontakter</h2><p id="contactsSubtitle">Alla kontakter</p></div>
                    <div class="header-actions">
                        <button class="btn btn-glass" data-action="export"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>Exportera</button>
                        <button class="btn btn-primary" data-action="import"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Lägg till</button>
                    </div>
                </div>

                <div class="search-filter-bar">
                    <div class="search-box">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                        <input type="search" class="search-input" id="searchInput" placeholder="Sök företag, kontakt, nummer...">
                    </div>
                    <select class="filter-select" id="operatorFilter">
                        <option value="">Alla operatörer</option>
                        <option value="telenor">Telenor</option>
                        <option value="tele2">Tele2</option>
                        <option value="tre">Tre</option>
                        <option value="telia">Telia</option>
                    </select>
                    <select class="filter-select" id="sortSelect">
                        <option value="">Sortera efter...</option>
                        <option value="name-asc">Namn A-Ö</option>
                        <option value="name-desc">Namn Ö-A</option>
                        <option value="phones-desc">Flest nummer</option>
                        <option value="phones-asc">Minst nummer</option>
                    </select>
                    <button class="btn btn-glass btn-sm" id="clearFilters"><svg viewBox="0 0 24 24" style="width:16px;height:16px"><path d="M3 6h18M6 6v14a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V6"/></svg>Rensa filter</button>
                </div>

                <div class="glass-panel">
                    <div class="table-container">
                        <table class="data-table" id="contactsTable">
                            <thead>
                                <tr>
                                    <th>Företag</th>
                                    <th>Org.nr</th>
                                    <th>Adress</th>
                                    <th>Ort</th>
                                    <th>Nummer</th>
                                    <th>Användare</th>
                                    <th>Operatör</th>
                                    <th>Kontakt</th>
                                    <th>Roll</th>
                                    <th>Anteckningar</th>
                                    <th>Åtgärder</th>
                                </tr>
                            </thead>
                            <tbody id="contactsTableBody"></tbody>
                        </table>
                    </div>
                    <div id="emptyContacts" class="empty-state" style="display:none;">
                        <svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
                        <h3>Inga kontakter</h3>
                        <p>Importera en CSV-fil för att komma igång.</p>
                    </div>
                </div>
            </section>

            <!-- Batches -->
            <section id="batchesView" class="view" style="display:none;">
                <div class="header">
                    <div class="header-left"><h2>Importerade Listor</h2><p>Hantera dina uppladdade listor</p></div>
                    <div class="header-actions">
                        <button class="btn btn-danger" id="deleteAllBtn"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>Radera alla</button>
                        <button class="btn btn-primary" data-action="import"><svg viewBox="0 0 24 24"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>Importera ny</button>
                    </div>
                </div>

                <div class="glass-panel">
                    <div class="panel-header"><h3 class="panel-title"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>Importerade listor</h3></div>
                    <div class="batch-list" id="batchList"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Import Modal -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <h2 class="modal-title">Importera Kontakter</h2>
                <button class="modal-close" data-close><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Listnamn (valfritt)</label>
                    <input type="text" class="form-input" id="batchName" placeholder="T.ex. 'December leads' eller 'Stockholm företag'">
                </div>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon"><svg viewBox="0 0 24 24"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
                    <div class="upload-text">Släpp din CSV-fil här</div>
                    <div class="upload-hint">eller klicka för att välja fil</div>
                    <input type="file" id="fileInput" accept=".csv" hidden>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-glass" data-close>Avbryt</button>
                <button class="btn btn-primary" id="processImportBtn" disabled><svg viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"/></svg>Importera</button>
            </div>
        </div>
    </div>

    <!-- Chat Panel -->
    <div class="chat-panel" id="chatPanel">
        <div class="chat-header">
            <div class="chat-header-left">
                <div class="chat-avatar"><svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4"/></svg></div>
                <div><div class="chat-title">AI Assistent</div><div class="chat-subtitle">Powered by Claude</div></div>
            </div>
            <button class="modal-close" id="closeChatBtn"><svg viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="chat-message assistant">Hej! Jag kan hjälpa dig med frågor om dina kontakter, statistik och navigering. Vad kan jag hjälpa dig med?</div>
        </div>
        <div class="chat-input-area">
            <div class="chat-input-wrapper">
                <input type="text" class="chat-input" id="chatInput" placeholder="Skriv ett meddelande...">
                <button class="chat-send" id="sendChatBtn"><svg viewBox="0 0 24 24"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg></button>
            </div>
        </div>
    </div>

    <button class="chat-toggle" id="chatToggleBtn"><svg viewBox="0 0 24 24"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg></button>

    <script>
        // ========== DATABASE ==========
        class RingoptimaDB {
            constructor() { this.dbName = 'RingoptimaDB'; this.dbVersion = 2; this.db = null; }

            async init() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => { this.db = request.result; resolve(this.db); };
                    request.onupgradeneeded = (e) => {
                        const db = e.target.result;
                        if (!db.objectStoreNames.contains('contacts')) {
                            const store = db.createObjectStore('contacts', { keyPath: 'id', autoIncrement: true });
                            store.createIndex('batchId', 'batchId', { unique: false });
                        }
                        if (!db.objectStoreNames.contains('batches')) {
                            db.createObjectStore('batches', { keyPath: 'id', autoIncrement: true });
                        }
                    };
                });
            }

            async addBatch(batch) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('batches', 'readwrite');
                    const store = tx.objectStore('batches');
                    batch.createdAt = new Date().toISOString();
                    const request = store.add(batch);
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async getAllBatches() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('batches', 'readonly');
                    const request = tx.objectStore('batches').getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteBatch(batchId) {
                const tx = this.db.transaction(['batches', 'contacts'], 'readwrite');
                tx.objectStore('batches').delete(batchId);
                const contactStore = tx.objectStore('contacts');
                const index = contactStore.index('batchId');
                const request = index.openCursor(IDBKeyRange.only(batchId));
                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) { cursor.delete(); cursor.continue(); }
                };
                return new Promise((resolve, reject) => {
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }

            async addContacts(contacts, batchId) {
                const tx = this.db.transaction('contacts', 'readwrite');
                const store = tx.objectStore('contacts');
                contacts.forEach(c => { c.batchId = batchId; c.createdAt = new Date().toISOString(); c.notes = ''; store.add(c); });
                return new Promise((resolve, reject) => { tx.oncomplete = () => resolve(); tx.onerror = () => reject(tx.error); });
            }

            async getAllContacts() {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('contacts', 'readonly');
                    const request = tx.objectStore('contacts').getAll();
                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async updateContact(id, updates) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('contacts', 'readwrite');
                    const store = tx.objectStore('contacts');
                    const getReq = store.get(id);
                    getReq.onsuccess = () => {
                        const contact = getReq.result;
                        if (contact) { Object.assign(contact, updates); store.put(contact); }
                    };
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }

            async deleteContact(id) {
                return new Promise((resolve, reject) => {
                    const tx = this.db.transaction('contacts', 'readwrite');
                    tx.objectStore('contacts').delete(id);
                    tx.oncomplete = () => resolve();
                    tx.onerror = () => reject(tx.error);
                });
            }

            async clearAll() {
                const tx = this.db.transaction(['contacts', 'batches'], 'readwrite');
                tx.objectStore('contacts').clear();
                tx.objectStore('batches').clear();
                return new Promise((resolve, reject) => { tx.oncomplete = () => resolve(); tx.onerror = () => reject(tx.error); });
            }
        }

        // ========== STATE ==========
        const state = { contacts: [], batches: [], filteredContacts: [], selectedFile: null, currentView: 'dashboard' };
        const db = new RingoptimaDB();

        // ========== UTILITIES ==========
        function showToast(msg, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.innerHTML = `<div class="toast-icon"><svg viewBox="0 0 24 24">${type === 'success' ? '<polyline points="20 6 9 17 4 12"/>' : '<line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>'}</svg></div><span class="toast-message">${msg}</span>`;
            document.getElementById('toastContainer').appendChild(toast);
            requestAnimationFrame(() => toast.classList.add('show'));
            setTimeout(() => { toast.classList.remove('show'); setTimeout(() => toast.remove(), 300); }, 3000);
        }

        function animateNumber(el, target, dur = 800) {
            const start = parseInt(el.textContent) || 0;
            const range = target - start;
            const startTime = performance.now();
            function update(time) {
                const progress = Math.min((time - startTime) / dur, 1);
                el.textContent = Math.floor(start + range * (1 - Math.pow(1 - progress, 3)));
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        function escapeHtml(text) { if (!text) return ''; const div = document.createElement('div'); div.textContent = text; return div.innerHTML; }

        function formatDate(iso) { return new Date(iso).toLocaleDateString('sv-SE', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); }

        // ========== CSV PARSING ==========
        function parseCSV(text) {
            const lines = text.split('\n'); const result = []; let currentLine = ''; let inQuotes = false;
            for (let line of lines) {
                currentLine += line;
                inQuotes = ((currentLine.match(/"/g) || []).length % 2 !== 0);
                if (!inQuotes) {
                    const row = []; let cell = ''; let inside = false;
                    for (let char of currentLine) {
                        if (char === '"') inside = !inside;
                        else if (char === ',' && !inside) { row.push(cell); cell = ''; }
                        else cell += char;
                    }
                    row.push(cell);
                    if (row.some(c => c.trim())) result.push(row);
                    currentLine = '';
                } else currentLine += '\n';
            }
            return result;
        }

        function extractData(simplePhone, phoneData, styrelse) {
            const numbers = [], users = [], operators = [];
            let kontakt = '', roll = '';

            if (phoneData) {
                const phonePattern = /^0\d{1,3}[-\s]?[\d\s-]{4,}/;
                const continuationPattern = /^[\d\s-]{2,}$/;
                const rawLines = phoneData.split('\n');

                // Pre-process: join lines that are continuations of phone numbers
                const processedLines = [];
                for (let i = 0; i < rawLines.length; i++) {
                    let line = rawLines[i].trim();
                    if (!line) continue;

                    // Check if next line is a continuation (just digits/spaces, not a new phone)
                    while (i + 1 < rawLines.length) {
                        const nextLine = rawLines[i + 1].trim();
                        // If next line is just digits/spaces (like "14 31" or "45 62") and doesn't start with 0, join it
                        if (nextLine && continuationPattern.test(nextLine) && !nextLine.startsWith('0')) {
                            line += ' ' + nextLine;
                            i++;
                        } else {
                            break;
                        }
                    }
                    processedLines.push(line);
                }

                for (let line of processedLines) {
                    if (line.startsWith('Telefonnummer') || line.startsWith('Är det') || line.startsWith('Info') || line.startsWith('+46') || line.startsWith('Information') || line.startsWith('Andra format') || line.startsWith('Nyhet') || line.startsWith('Hittar') || line.startsWith('Lås upp') || line.startsWith('Köp för')) continue;
                    if (phonePattern.test(line)) {
                        let parts = line.split('\t').filter(p => p.trim());
                        if (parts.length < 3) parts = line.split(/\s{4,}/).filter(p => p.trim());
                        if (parts.length < 3) parts = line.split(/\s{2,}/).filter(p => p.trim());
                        if (parts.length >= 3) {
                            // Clean up phone number - remove extra spaces
                            let phone = parts[0].trim().replace(/\s+/g, ' ');
                            numbers.push(phone);
                            users.push(parts[1].trim());
                            let op = parts[2].trim().replace(/\s*\(mobile\)/gi, '').replace(/\s*\(fix\)/gi, '');
                            if (op && !op.toLowerCase().includes('kontakta')) operators.push(op);
                        } else if (parts.length >= 1) {
                            let phone = parts[0].trim().replace(/\s+/g, ' ');
                            numbers.push(phone);
                        }
                    }
                }
            }
            if (numbers.length === 0 && simplePhone?.trim() && /^0\d{1,3}[-\s]?[\d\s-]{4,}/.test(simplePhone)) numbers.push(simplePhone.trim());

            if (styrelse) {
                const patterns = [
                    [/Verkställande direktör[:\t\s]+([^\n\t]+)/i, 'Verkställande direktör'],
                    [/Extern verkställande direktör[:\t\s]+([^\n\t]+)/i, 'Extern VD'],
                    [/Ordförande[:\t\s]+([^\n\t]+)/i, 'Ordförande'],
                    [/Styrelseledamot[:\t\s]+([^\n\t]+)/i, 'Styrelseledamot'],
                    [/Styrelsesuppleant[:\t\s]+([^\n\t]+)/i, 'Styrelsesuppleant']
                ];
                for (const [pat, r] of patterns) {
                    const m = styrelse.match(pat);
                    if (m) { let name = m[1].trim().split('\t')[0].trim(); if (name && !name.toLowerCase().includes('lägg till')) { kontakt = name; roll = r; break; } }
                }
            }
            return { phones: numbers.join('\n'), users: users.join('\n'), operators: operators.join('\n'), contact: kontakt, role: roll };
        }

        function transformCSV(rows) {
            const contacts = [];
            for (let i = 1; i < rows.length; i++) {
                const r = rows[i];
                if (r.length < 3 || !r[0]?.trim()) continue;
                const ex = extractData(r[4] || '', r[5] || '', r[6] || '');
                contacts.push({ name: r[0].trim(), org: (r[1] || '').trim(), address: (r[2] || '').trim(), city: (r[3] || '').trim(), ...ex });
            }
            return contacts;
        }

        // ========== UI UPDATES ==========
        function updateStats() {
            const total = state.contacts.length;
            let telenor = 0, tele2 = 0, tre = 0, telia = 0;
            state.contacts.forEach(c => {
                const ops = (c.operators || '').toLowerCase();
                if (ops.includes('telenor')) telenor++;
                if (ops.includes('tele2')) tele2++;
                if (ops.includes('hi3g') || ops.includes('tre')) tre++;
                if (ops.includes('telia')) telia++;
            });
            animateNumber(document.getElementById('statTotal'), total);
            animateNumber(document.getElementById('statTelenor'), telenor);
            animateNumber(document.getElementById('statTele2'), tele2);
            animateNumber(document.getElementById('statTre'), tre);
            animateNumber(document.getElementById('statTelia'), telia);
            document.getElementById('contactCount').textContent = total;
            document.getElementById('sidebarTotal').textContent = total;
            document.getElementById('sidebarBatches').textContent = state.batches.length;
        }

        function renderContacts() {
            let contacts = [...state.contacts];
            const search = document.getElementById('searchInput').value.toLowerCase();
            const opFilter = document.getElementById('operatorFilter').value;
            const sort = document.getElementById('sortSelect').value;

            if (search) contacts = contacts.filter(c => c.name.toLowerCase().includes(search) || c.org.includes(search) || c.phones.includes(search) || c.contact.toLowerCase().includes(search));

            if (opFilter) {
                const map = { telenor: ['telenor'], tele2: ['tele2'], tre: ['hi3g', 'tre'], telia: ['telia', 'teliasonera'] };
                contacts = contacts.filter(c => map[opFilter]?.some(t => c.operators.toLowerCase().includes(t)));
            }

            if (sort) {
                contacts.sort((a, b) => {
                    if (sort === 'name-asc') return a.name.localeCompare(b.name, 'sv');
                    if (sort === 'name-desc') return b.name.localeCompare(a.name, 'sv');
                    if (sort === 'phones-desc') return b.phones.split('\n').filter(p=>p).length - a.phones.split('\n').filter(p=>p).length;
                    if (sort === 'phones-asc') return a.phones.split('\n').filter(p=>p).length - b.phones.split('\n').filter(p=>p).length;
                    return 0;
                });
            }

            state.filteredContacts = contacts;
            document.getElementById('contactsSubtitle').textContent = `Visar ${contacts.length} av ${state.contacts.length} kontakter`;

            const tbody = document.getElementById('contactsTableBody');
            const empty = document.getElementById('emptyContacts');

            if (contacts.length === 0) {
                tbody.innerHTML = '';
                empty.style.display = state.contacts.length === 0 ? 'block' : 'none';
                if (state.contacts.length > 0) tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:40px;color:rgba(255,255,255,0.7)">Inga kontakter matchar din sökning</td></tr>';
                return;
            }

            empty.style.display = 'none';
            tbody.innerHTML = contacts.map(c => `
                <tr data-id="${c.id}">
                    <td class="cell-company" title="${escapeHtml(c.name)}">${escapeHtml(c.name)}</td>
                    <td>${escapeHtml(c.org)}</td>
                    <td>${escapeHtml(c.address)}</td>
                    <td>${escapeHtml(c.city)}</td>
                    <td class="cell-multiline">${escapeHtml(c.phones)}</td>
                    <td class="cell-multiline">${escapeHtml(c.users)}</td>
                    <td class="cell-multiline">${escapeHtml(c.operators)}</td>
                    <td>${escapeHtml(c.contact)}</td>
                    <td>${escapeHtml(c.role)}</td>
                    <td class="inline-note"><textarea placeholder="Anteckningar..." data-id="${c.id}">${escapeHtml(c.notes || '')}</textarea></td>
                    <td>
                        <div class="row-actions">
                            <button class="action-btn call" title="Ring" data-call="${c.id}"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3"/></svg></button>
                            <button class="action-btn delete" title="Radera" data-delete="${c.id}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderBatches() {
            const list = document.getElementById('batchList');
            if (state.batches.length === 0) {
                list.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg><h3>Inga listor</h3><p>Importera en CSV-fil för att skapa din första lista.</p></div>';
                return;
            }
            list.innerHTML = state.batches.map(b => {
                const count = state.contacts.filter(c => c.batchId === b.id).length;
                return `
                    <div class="batch-item">
                        <div class="batch-info">
                            <div class="batch-name">${escapeHtml(b.name || 'Namnlös lista')}</div>
                            <div class="batch-meta">${count} kontakter - Importerad ${formatDate(b.createdAt)}</div>
                        </div>
                        <div class="batch-actions">
                            <button class="btn btn-sm btn-glass" data-view-batch="${b.id}">Visa</button>
                            <button class="btn btn-sm btn-danger" data-delete-batch="${b.id}">Radera</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderRecentContacts() {
            const recent = [...state.contacts].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)).slice(0, 5);
            const el = document.getElementById('recentContacts');
            if (recent.length === 0) {
                el.innerHTML = '<div class="empty-state"><svg viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></svg><h3>Inga kontakter</h3><p>Importera en CSV-fil för att komma igång.</p></div>';
                return;
            }
            el.innerHTML = '<table class="data-table" style="min-width:auto"><thead><tr><th>Företag</th><th>Kontakt</th><th>Roll</th><th>Nummer</th></tr></thead><tbody>' +
                recent.map(c => `<tr><td>${escapeHtml(c.name)}</td><td>${escapeHtml(c.contact)}</td><td>${escapeHtml(c.role)}</td><td>${escapeHtml(c.phones.split('\n')[0])}</td></tr>`).join('') +
                '</tbody></table>';
        }

        // ========== VIEW MANAGEMENT ==========
        function switchView(view, filter = null) {
            state.currentView = view;
            document.querySelectorAll('.view').forEach(v => v.style.display = 'none');
            document.getElementById(`${view}View`).style.display = 'block';
            document.querySelectorAll('.nav-item[data-view]').forEach(n => n.classList.toggle('active', n.dataset.view === view));
            document.getElementById('sidebar').classList.remove('open');

            if (view === 'contacts' && filter) {
                document.getElementById('operatorFilter').value = filter === 'all' ? '' : filter;
                renderContacts();
            }
        }

        function openModal(id) { document.getElementById(id).classList.add('active'); }
        function closeModal(id) { document.getElementById(id).classList.remove('active'); }

        // ========== EVENT HANDLERS ==========
        async function handleImport() {
            if (!state.selectedFile) return;
            try {
                const text = await state.selectedFile.text();
                const rows = parseCSV(text);
                const contacts = transformCSV(rows);
                if (contacts.length === 0) { showToast('Inga kontakter hittades', 'error'); return; }

                const batchName = document.getElementById('batchName').value.trim() || state.selectedFile.name;
                const batchId = await db.addBatch({ name: batchName, fileName: state.selectedFile.name, count: contacts.length });
                await db.addContacts(contacts, batchId);

                state.contacts = await db.getAllContacts();
                state.batches = await db.getAllBatches();

                updateStats(); renderContacts(); renderBatches(); renderRecentContacts();
                closeModal('importModal');
                showToast(`${contacts.length} kontakter importerade!`);

                // Reset
                state.selectedFile = null;
                document.getElementById('batchName').value = '';
                document.getElementById('uploadArea').querySelector('.upload-text').textContent = 'Släpp din CSV-fil här';
                document.getElementById('processImportBtn').disabled = true;
            } catch (e) { showToast('Fel: ' + e.message, 'error'); }
        }

        async function handleDeleteContact(id) {
            if (!confirm('Radera denna kontakt?')) return;
            await db.deleteContact(id);
            state.contacts = await db.getAllContacts();
            updateStats(); renderContacts(); renderRecentContacts();
            showToast('Kontakt raderad', 'info');
        }

        async function handleDeleteBatch(id) {
            const batch = state.batches.find(b => b.id === id);
            if (!confirm(`Radera listan "${batch?.name}" och alla dess kontakter?`)) return;
            await db.deleteBatch(id);
            state.contacts = await db.getAllContacts();
            state.batches = await db.getAllBatches();
            updateStats(); renderContacts(); renderBatches(); renderRecentContacts();
            showToast('Lista raderad', 'info');
        }

        async function handleDeleteAll() {
            if (!confirm('Radera ALLA listor och kontakter? Detta kan inte ångras.')) return;
            await db.clearAll();
            state.contacts = []; state.batches = [];
            updateStats(); renderContacts(); renderBatches(); renderRecentContacts();
            showToast('Allt raderat', 'info');
        }

        async function saveNote(id, note) {
            await db.updateContact(id, { notes: note });
            const contact = state.contacts.find(c => c.id === id);
            if (contact) contact.notes = note;
        }

        function exportCSV() {
            const contacts = state.filteredContacts.length ? state.filteredContacts : state.contacts;
            if (!contacts.length) { showToast('Inga kontakter att exportera', 'error'); return; }
            const headers = ['NAMN', 'ORG', 'ADRESS', 'ORT', 'NUMMER', 'ANVÄNDARE', 'OPERATÖR', 'KONTAKT', 'ROLL', 'ANTECKNINGAR'];
            const rows = contacts.map(c => [c.name, c.org, c.address, c.city, c.phones, c.users, c.operators, c.contact, c.role, c.notes || '']);
            const csv = [headers, ...rows].map(r => r.map(cell => cell?.includes(',') || cell?.includes('\n') ? `"${cell.replace(/"/g, '""')}"` : cell || '').join(',')).join('\n');
            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ringoptima_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
            showToast(`${contacts.length} kontakter exporterade!`);
        }

        // ========== CHAT ==========
        function toggleChat() { document.getElementById('chatPanel').classList.toggle('open'); }

        function addChatMsg(text, isUser) {
            const div = document.createElement('div');
            div.className = `chat-message ${isUser ? 'user' : 'assistant'}`;
            div.textContent = text;
            document.getElementById('chatMessages').appendChild(div);
            div.scrollIntoView({ behavior: 'smooth' });
        }

        function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            addChatMsg(msg, true);
            input.value = '';

            let response = '';
            const lower = msg.toLowerCase();
            if (lower.includes('hur många') || lower.includes('antal')) {
                response = `Du har ${state.contacts.length} kontakter i ${state.batches.length} listor.`;
            } else if (lower.includes('telia')) {
                response = `${state.contacts.filter(c => c.operators.toLowerCase().includes('telia')).length} kontakter har Telia.`;
            } else if (lower.includes('telenor')) {
                response = `${state.contacts.filter(c => c.operators.toLowerCase().includes('telenor')).length} kontakter har Telenor.`;
            } else if (lower.includes('tele2')) {
                response = `${state.contacts.filter(c => c.operators.toLowerCase().includes('tele2')).length} kontakter har Tele2.`;
            } else if (lower.includes('tre')) {
                response = `${state.contacts.filter(c => c.operators.toLowerCase().includes('hi3g') || c.operators.toLowerCase().includes('tre')).length} kontakter har Tre.`;
            } else if (lower.includes('export')) {
                response = 'Klicka på "Exportera CSV" i sidomenyn för att ladda ner alla kontakter.';
            } else if (lower.includes('radera') || lower.includes('ta bort')) {
                response = 'Gå till "Importerade Listor" för att radera hela listor, eller använd papperskorgen i kontaktvyn för enskilda kontakter.';
            } else {
                response = 'Jag kan hjälpa med: antal kontakter, operatörsstatistik, export, radering. Vad vill du veta?';
            }
            setTimeout(() => addChatMsg(response), 300);
        }

        // ========== INIT ==========
        async function init() {
            await db.init();
            state.contacts = await db.getAllContacts();
            state.batches = await db.getAllBatches();

            updateStats(); renderContacts(); renderBatches(); renderRecentContacts();

            // Sidebar toggle (slide left/right)
            document.getElementById('sidebarToggle').addEventListener('click', () => {
                document.body.classList.toggle('sidebar-hidden');
                document.getElementById('sidebar').classList.toggle('hidden');
            });

            // Nav
            document.querySelectorAll('.nav-item[data-view]').forEach(n => n.addEventListener('click', () => switchView(n.dataset.view)));
            document.querySelectorAll('[data-action]').forEach(b => {
                b.addEventListener('click', () => {
                    if (b.dataset.action === 'import') openModal('importModal');
                    if (b.dataset.action === 'export') exportCSV();
                });
            });

            // Stat cards - clickable filter
            document.querySelectorAll('.stat-card[data-filter]').forEach(card => {
                card.addEventListener('click', () => {
                    document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    switchView('contacts', card.dataset.filter);
                });
            });

            // Mobile
            document.getElementById('mobileMenuBtn').addEventListener('click', () => document.getElementById('sidebar').classList.toggle('open'));

            // Upload
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            uploadArea.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', (e) => {
                state.selectedFile = e.target.files[0];
                if (state.selectedFile) {
                    uploadArea.querySelector('.upload-text').textContent = state.selectedFile.name;
                    document.getElementById('processImportBtn').disabled = false;
                }
            });
            uploadArea.addEventListener('dragover', (e) => { e.preventDefault(); uploadArea.classList.add('dragover'); });
            uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('dragover'));
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault(); uploadArea.classList.remove('dragover');
                state.selectedFile = e.dataTransfer.files[0];
                if (state.selectedFile?.name.endsWith('.csv')) {
                    uploadArea.querySelector('.upload-text').textContent = state.selectedFile.name;
                    document.getElementById('processImportBtn').disabled = false;
                }
            });

            document.getElementById('processImportBtn').addEventListener('click', handleImport);

            // Close modals
            document.querySelectorAll('[data-close]').forEach(b => b.addEventListener('click', () => closeModal('importModal')));
            document.getElementById('importModal').addEventListener('click', (e) => { if (e.target.id === 'importModal') closeModal('importModal'); });

            // Filters
            document.getElementById('searchInput').addEventListener('input', renderContacts);
            document.getElementById('operatorFilter').addEventListener('change', renderContacts);
            document.getElementById('sortSelect').addEventListener('change', renderContacts);
            document.getElementById('clearFilters').addEventListener('click', () => {
                document.getElementById('searchInput').value = '';
                document.getElementById('operatorFilter').value = '';
                document.getElementById('sortSelect').value = '';
                document.querySelectorAll('.stat-card').forEach(c => c.classList.remove('active'));
                renderContacts();
            });

            // Table actions
            document.getElementById('contactsTableBody').addEventListener('click', (e) => {
                const callBtn = e.target.closest('[data-call]');
                const delBtn = e.target.closest('[data-delete]');
                if (callBtn) {
                    const c = state.contacts.find(x => x.id === parseInt(callBtn.dataset.call));
                    if (c?.phones) window.open(`tel:${c.phones.split('\n')[0].replace(/\s/g, '')}`, '_self');
                }
                if (delBtn) handleDeleteContact(parseInt(delBtn.dataset.delete));
            });

            // Notes save on blur
            document.getElementById('contactsTableBody').addEventListener('focusout', (e) => {
                if (e.target.matches('textarea[data-id]')) {
                    saveNote(parseInt(e.target.dataset.id), e.target.value);
                }
            });

            // Batch actions
            document.getElementById('batchList').addEventListener('click', (e) => {
                const viewBtn = e.target.closest('[data-view-batch]');
                const delBtn = e.target.closest('[data-delete-batch]');
                if (viewBtn) {
                    // Filter contacts by batch - show in contacts view
                    switchView('contacts');
                    // Custom filter for this batch
                    const batchId = parseInt(viewBtn.dataset.viewBatch);
                    const filtered = state.contacts.filter(c => c.batchId === batchId);
                    state.filteredContacts = filtered;
                    document.getElementById('contactsSubtitle').textContent = `Visar ${filtered.length} kontakter från vald lista`;
                    const tbody = document.getElementById('contactsTableBody');
                    tbody.innerHTML = filtered.map(c => `
                        <tr data-id="${c.id}">
                            <td class="cell-company">${escapeHtml(c.name)}</td>
                            <td>${escapeHtml(c.org)}</td>
                            <td>${escapeHtml(c.address)}</td>
                            <td>${escapeHtml(c.city)}</td>
                            <td class="cell-multiline">${escapeHtml(c.phones)}</td>
                            <td class="cell-multiline">${escapeHtml(c.users)}</td>
                            <td class="cell-multiline">${escapeHtml(c.operators)}</td>
                            <td>${escapeHtml(c.contact)}</td>
                            <td>${escapeHtml(c.role)}</td>
                            <td class="inline-note"><textarea data-id="${c.id}">${escapeHtml(c.notes || '')}</textarea></td>
                            <td><div class="row-actions"><button class="action-btn call" data-call="${c.id}"><svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07"/></svg></button><button class="action-btn delete" data-delete="${c.id}"><svg viewBox="0 0 24 24"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button></div></td>
                        </tr>
                    `).join('');
                }
                if (delBtn) handleDeleteBatch(parseInt(delBtn.dataset.deleteBatch));
            });

            document.getElementById('deleteAllBtn').addEventListener('click', handleDeleteAll);

            // Chat
            document.getElementById('chatToggleBtn').addEventListener('click', toggleChat);
            document.getElementById('openChatBtn').addEventListener('click', toggleChat);
            document.getElementById('closeChatBtn').addEventListener('click', toggleChat);
            document.getElementById('sendChatBtn').addEventListener('click', sendChat);
            document.getElementById('chatInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChat(); });

            // Keyboard
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') { closeModal('importModal'); document.getElementById('chatPanel').classList.remove('open'); }
            });
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
